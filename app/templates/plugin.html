{% extends "base.html" %}

{% block title %}{{ plugin.name }} - Plugin System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">{{ plugin.name }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0">
                    <i class="bi bi-plugin me-2"></i>
                    {{ plugin.name }}
                </h2>
                <small>Version {{ plugin.version }}</small>
            </div>
            <div class="card-body">
                <p class="card-text mb-4">{{ plugin.description }}</p>
                
                <form action="/plugin/{{ plugin.id }}/execute" method="post" enctype="multipart/form-data" id="pluginForm">
                    {% for input_field in plugin.inputs %}
                    <div class="mb-3">
                        <label for="{{ input_field.name }}" class="form-label">
                            {{ input_field.label }}
                            {% if input_field.required %}
                                <span class="text-danger">*</span>
                            {% endif %}
                        </label>
                        
                        {% if input_field.field_type == "text" %}
                            <input type="text" 
                                   class="form-control" 
                                   id="{{ input_field.name }}" 
                                   name="{{ input_field.name }}"
                                   {% if input_field.placeholder %}placeholder="{{ input_field.placeholder }}"{% endif %}
                                   {% if input_field.required %}required{% endif %}
                                   {% if input_field.default_value %}value="{{ input_field.default_value }}"{% endif %}>
                        
                        {% elif input_field.field_type == "textarea" %}
                            <textarea class="form-control" 
                                      id="{{ input_field.name }}" 
                                      name="{{ input_field.name }}"
                                      rows="8"
                                      {% if input_field.placeholder %}placeholder="{{ input_field.placeholder }}"{% endif %}
                                      {% if input_field.required %}required{% endif %}>{% if input_field.default_value %}{{ input_field.default_value }}{% endif %}</textarea>
                        
                        {% elif input_field.field_type == "number" %}
                            <input type="number" 
                                   class="form-control" 
                                   id="{{ input_field.name }}" 
                                   name="{{ input_field.name }}"
                                   {% if input_field.placeholder %}placeholder="{{ input_field.placeholder }}"{% endif %}
                                   {% if input_field.required %}required{% endif %}
                                   {% if input_field.default_value %}value="{{ input_field.default_value }}"{% endif %}>
                        
                        {% elif input_field.field_type == "select" %}
                            <select class="form-select" 
                                    id="{{ input_field.name }}" 
                                    name="{{ input_field.name }}"
                                    {% if input_field.required %}required{% endif %}>
                                {% if not input_field.required %}
                                    <option value="">Choose...</option>
                                {% endif %}
                                {% if input_field.options %}
                                    {% for option in input_field.options %}
                                        <option value="{{ option }}" 
                                                {% if input_field.default_value == option %}selected{% endif %}>
                                            {{ option }}
                                        </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        
                        {% elif input_field.field_type == "checkbox" %}
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       id="{{ input_field.name }}" 
                                       name="{{ input_field.name }}"
                                       value="true"
                                       {% if input_field.default_value %}checked{% endif %}>
                                <label class="form-check-label" for="{{ input_field.name }}">
                                    Enable {{ input_field.label }}
                                </label>
                            </div>
                        
                        {% elif input_field.field_type == "file" %}
                            <input type="file" 
                                   class="form-control" 
                                   id="{{ input_field.name }}" 
                                   name="{{ input_field.name }}"
                                   {% if input_field.validation and input_field.validation.allowed_extensions %}
                                   accept=".{{ input_field.validation.allowed_extensions | join(',.') }}"
                                   {% endif %}
                                   {% if input_field.required %}required{% endif %}>
                        {% endif %}
                        
                        {% if input_field.validation %}
                            <div class="form-text">
                                {% if input_field.validation.min_length %}
                                    Minimum {{ input_field.validation.min_length }} characters.
                                {% endif %}
                                {% if input_field.validation.max_length %}
                                    Maximum {{ input_field.validation.max_length }} characters.
                                {% endif %}
                            </div>
                        {% endif %}
                        {% if input_field.help_text %}
                            <div class="form-text text-muted small mt-1">{{ input_field.help_text }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary btn-lg" id="executeBtn">
                            <i class="bi bi-play-circle me-2"></i>
                            Execute Plugin
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Plugin Information -->
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Plugin Information
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">ID:</dt>
                    <dd class="col-sm-8"><code>{{ plugin.id }}</code></dd>
                    
                    <dt class="col-sm-4">Version:</dt>
                    <dd class="col-sm-8">{{ plugin.version }}</dd>
                    
                    {% if plugin.author %}
                    <dt class="col-sm-4">Author:</dt>
                    <dd class="col-sm-8">{{ plugin.author }}</dd>
                    {% endif %}
                    
                    <dt class="col-sm-4">Inputs:</dt>
                    <dd class="col-sm-8">{{ plugin.inputs|length }} field(s)</dd>
                    
                    <dt class="col-sm-4">Output:</dt>
                    <dd class="col-sm-8">{{ plugin.output.name }}</dd>
                </dl>
                
                {% if plugin.tags %}
                <div class="mt-3">
                    <strong>Tags:</strong><br>
                    {% for tag in plugin.tags %}
                        <span class="badge bg-secondary me-1">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Output Format -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-earmark-code me-2"></i>
                    Output Format
                </h5>
            </div>
            <div class="card-body">
                <h6>{{ plugin.output.name }}</h6>
                <p class="text-muted small">{{ plugin.output.description }}</p>
                
                <div class="accordion accordion-flush" id="outputSchema">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#schemaCollapse">
                                View Schema
                            </button>
                        </h2>
                        <div id="schemaCollapse" class="accordion-collapse collapse" data-bs-parent="#outputSchema">
                            <div class="accordion-body">
                                <pre class="small"><code>{{ plugin.output.schema_definition | tojsonpretty }}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('pluginForm');
    const btn = document.getElementById('executeBtn');
    
    if (form) {
        form.addEventListener('submit', function() {
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Processing...
                `;
            }
        });
    }

    // Reset button state on page load (e.g., when using back button)
    window.addEventListener('pageshow', function(event) {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'Execute Plugin';
        }
    });
});
</script>
{% endblock %} 