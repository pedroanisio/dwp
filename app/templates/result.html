{% extends "base.html" %}

{% block title %}EXECUTION RESULTS - {{ plugin.name|upper }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb mt-3">
        <ol>
            <li><a href="/">NEURAL MATRIX</a></li>
            <li><a href="/plugin/{{ plugin.id }}">{{ plugin.name|upper }}</a></li>
            <li>EXECUTION RESULTS</li>
        </ol>
    </div>

    <!-- Header Section -->
    <div class="hero" style="padding: 60px 0;">
        <div class="text-center">
            <h1 class="glitch" data-text="EXECUTION RESULTS">EXECUTION RESULTS</h1>
            <div class="mt-4">
                <a href="/plugin/{{ plugin.id }}" class="btn btn-primary">
                    RE-EXECUTE MODULE
                </a>
                <a href="/" class="btn btn-secondary">
                    RETURN TO MATRIX
                </a>
            </div>
        </div>
    </div>

    <!-- Execution Status Section -->
    <div class="row mb-5">
        <div class="col-12">
            {% if result.success %}
                <div class="alert alert-success">
                    <h3>⚡ EXECUTION SUCCESSFUL</h3>
                    <p>Neural module processed data successfully. Operation completed without errors.</p>
                    {% if result.execution_time %}
                        <div class="mt-2">
                            <strong>Processing Time:</strong> 
                            <code>{{ "%.3f"|format(result.execution_time) }}s</code>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-secondary">
                    <h3>⚠️ EXECUTION FAILED</h3>
                    <p>The neural module encountered a critical error during processing.</p>
                    <div class="mt-3">
                        <strong class="text-primary">Error Details:</strong>
                        <div class="mt-2">
                            <code id="error-text" class="d-block p-3" style="background: var(--darker-bg); border: 1px solid var(--border-glow); white-space: pre-wrap;">{{ result.error }}</code>
                        </div>
                        <button class="btn btn-outline mt-2" onclick="copyToClipboard()" id="copyBtn">
                            COPY ERROR LOG
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    {% if result.success and result.data %}
    <div class="row">
        <!-- Results Display -->
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{ plugin.name|upper }} OUTPUT</h3>
                    <small class="text-secondary">Neural Processing Results</small>
                </div>
                <div class="card-body">
                    {% if result.data.custom_template is defined %}
                        {# The plugin has provided a custom template to render its output #}
                        {% include result.data.custom_template %}
                    
                    {% else %}
                        {# Enhanced display for key-value data #}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>DATA FIELD</th>
                                        <th>OUTPUT VALUE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for key, value in result.data.items() %}
                                    <tr>
                                        <th>{{ key.replace('_', ' ')|upper }}</th>
                                        <td>
                                            {% if value is mapping %}
                                                <div class="accordion mb-2">
                                                    <div class="accordion-header">
                                                        <button type="button" class="accordion-button" onclick="toggleData('{{ key }}')">
                                                            VIEW OBJECT DATA
                                                        </button>
                                                    </div>
                                                    <div id="data-{{ key }}" class="accordion-body" style="display: none;">
                                                        <pre><code>{{ value | tojsonpretty }}</code></pre>
                                                    </div>
                                                </div>
                                            {% elif value is sequence and value is not string %}
                                                {% if value|length > 10 %}
                                                    <div class="accordion mb-2">
                                                        <div class="accordion-header">
                                                            <button type="button" class="accordion-button" onclick="toggleData('{{ key }}')">
                                                                VIEW {{ value|length }} ITEMS
                                                            </button>
                                                        </div>
                                                        <div id="data-{{ key }}" class="accordion-body" style="display: none;">
                                                            <ul class="list-group">
                                                                {% for item in value %}
                                                                    <li class="list-group-item">{{ item }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <ul class="list-group">
                                                        {% for item in value %}
                                                            <li class="list-group-item">{{ item }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% endif %}
                                            {% elif value is number %}
                                                <span class="text-primary">{{ value }}</span>
                                            {% elif value|string|length > 100 %}
                                                <div class="accordion mb-2">
                                                    <div class="accordion-header">
                                                        <button type="button" class="accordion-button" onclick="toggleData('{{ key }}')">
                                                            VIEW LONG TEXT ({{ value|string|length }} chars)
                                                        </button>
                                                    </div>
                                                    <div id="data-{{ key }}" class="accordion-body" style="display: none;">
                                                        <div style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;">{{ value }}</div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                {{ value }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar Information -->
        <div class="col-12 col-lg-4">
            <!-- Input Summary -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">INPUT PARAMETERS</h5>
                </div>
                <div class="card-body">
                    {% if input_data.input_file %}
                        <div class="mb-3">
                            <dt>File Upload:</dt>
                            <dd>
                                <code>{{ input_data.input_file.filename }}</code>
                            </dd>
                        </div>
                    {% endif %}

                    {% for key, value in input_data.items() %}
                        {% if key != 'input_file' %}
                            <div class="mb-3">
                                <dt>{{ key.replace('_', ' ')|upper }}:</dt>
                                <dd>
                                    {% if value|string|length > 50 %}
                                        <div class="accordion">
                                            <div class="accordion-header">
                                                <button type="button" class="accordion-button" onclick="toggleData('input-{{ key }}')">
                                                    VIEW INPUT
                                                </button>
                                            </div>
                                            <div id="data-input-{{ key }}" class="accordion-body" style="display: none;">
                                                <div style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">{{ value }}</div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <code>{{ value }}</code>
                                    {% endif %}
                                </dd>
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    {% if not input_data or input_data|length == 0 %}
                        <p class="text-secondary">No input parameters provided.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Execution Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">EXECUTION STATS</h5>
                </div>
                <div class="card-body">
                    <dl>
                        <dt>Module ID:</dt>
                        <dd><code>{{ plugin.id }}</code></dd>
                        
                        <dt>Status:</dt>
                        <dd>
                            {% if result.success %}
                                <span class="text-success">✓ SUCCESS</span>
                            {% else %}
                                <span class="text-accent">✗ FAILED</span>
                            {% endif %}
                        </dd>
                        
                        {% if result.execution_time %}
                        <dt>Processing Time:</dt>
                        <dd><code>{{ "%.3f"|format(result.execution_time) }}s</code></dd>
                        {% endif %}
                        
                        <dt>Output Fields:</dt>
                        <dd>{{ result.data|length if result.data else 0 }} field(s)</dd>
                        
                        <dt>Timestamp:</dt>
                        <dd id="execution-timestamp"></dd>
                    </dl>
                </div>
            </div>
            
            <!-- Raw JSON Output -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">RAW DATA EXPORT</h5>
                </div>
                <div class="card-body">
                    <div class="accordion">
                        <div class="accordion-header">
                            <button type="button" class="accordion-button" onclick="toggleRawData()">
                                VIEW JSON OUTPUT
                            </button>
                        </div>
                        <div id="rawCollapse" class="accordion-body" style="display: none;">
                            <pre><code>{{ result.data | tojsonpretty }}</code></pre>
                            <button class="btn btn-outline mt-2" onclick="copyJsonToClipboard()">
                                COPY JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Copy error to clipboard
function copyToClipboard() {
    const errorText = document.getElementById('error-text').innerText;
    navigator.clipboard.writeText(errorText).then(() => {
        const copyBtn = document.getElementById('copyBtn');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '✓ COPIED';
        copyBtn.classList.add('text-success');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('text-success');
        }, 2000);
    });
}

// Copy JSON to clipboard
function copyJsonToClipboard() {
    const jsonText = document.querySelector('#rawCollapse pre code').innerText;
    navigator.clipboard.writeText(jsonText).then(() => {
        const copyBtn = event.target;
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '✓ COPIED';
        copyBtn.classList.add('text-success');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('text-success');
        }, 2000);
    });
}

// Toggle data displays
function toggleData(key) {
    const element = document.getElementById('data-' + key);
    const button = event.target;
    
    if (element.style.display === 'none') {
        element.style.display = 'block';
        button.textContent = button.textContent.replace('VIEW', 'HIDE');
    } else {
        element.style.display = 'none';
        button.textContent = button.textContent.replace('HIDE', 'VIEW');
    }
}

// Toggle raw data display
function toggleRawData() {
    const element = document.getElementById('rawCollapse');
    const button = event.target;
    
    if (element.style.display === 'none') {
        element.style.display = 'block';
        button.textContent = 'HIDE JSON OUTPUT';
    } else {
        element.style.display = 'none';
        button.textContent = 'VIEW JSON OUTPUT';
    }
}

// Set execution timestamp
function setTimestamp() {
    const now = new Date();
    const timestamp = now.getFullYear() + '.' + 
                     String(now.getMonth() + 1).padStart(2, '0') + '.' + 
                     String(now.getDate()).padStart(2, '0') + '.' + 
                     String(now.getHours()).padStart(2, '0') + ':' + 
                     String(now.getMinutes()).padStart(2, '0') + ':' + 
                     String(now.getSeconds()).padStart(2, '0');
    const timestampElement = document.getElementById('execution-timestamp');
    if (timestampElement) {
        timestampElement.textContent = timestamp;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setTimestamp();
    
    // Animate cards on load
    document.querySelectorAll('.card').forEach((card, index) => {
        card.style.animation = `fadeInCyber 0.6s ease-out ${index * 0.1}s both`;
    });
    
    // Random glitch effect for title
    setTimeout(() => {
        const title = document.querySelector('.glitch');
        if (title) {
            title.style.animation = 'glitch-1 0.5s ease-in-out';
            setTimeout(() => {
                title.style.animation = '';
            }, 500);
        }
    }, 1000);
});
</script>
{% endblock %} 