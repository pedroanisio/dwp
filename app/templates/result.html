{% extends "base.html" %}
{% from "components/button.html" import button %}

{% block title %}EXECUTION RESULTS - {{ plugin.name|upper }}{% endblock %}

{% block content %}
<div class="container mx-auto">
    <!-- Breadcrumb Navigation -->
    <div class="my-4">
        <nav class="flex" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="/" class="inline-flex items-center text-sm font-medium text-muted-foreground hover:text-primary">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                         MATRIX
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-muted-foreground" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                        <a href="/plugin/{{ plugin.id }}" class="ml-1 text-sm font-medium text-muted-foreground hover:text-primary md:ml-2">{{ plugin.name|upper }}</a>
                    </div>
                </li>
                <li aria-current="page">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-muted-foreground" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                        <span class="ml-1 text-sm font-medium text-foreground md:ml-2">EXECUTION RESULTS</span>
                    </div>
                </li>
            </ol>
        </nav>
    </div>

    <!-- Header Section -->
    <div class="py-12 text-center">
        <h1 class="text-4xl font-bold">EXECUTION RESULTS</h1>
        <div class="mt-4 flex space-x-2 justify-center">
            <a href="/plugin/{{ plugin.id }}">
                {{ button(variant='primary', text='RE-EXECUTE MODULE') }}
            </a>
            <a href="/">
                {{ button(variant='secondary', text='RETURN TO MATRIX') }}
            </a>
        </div>
    </div>

    <!-- Execution Status Section -->
    <div class="my-8">
        {% if result.success %}
            <div class="p-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
                <h3 class="text-lg font-bold">⚡ EXECUTION SUCCESSFUL</h3>
                <p> module processed data successfully. Operation completed without errors.</p>
                {% if result.execution_time %}
                    <div class="mt-2">
                        <strong>Processing Time:</strong> 
                        <code>{{ "%.3f"|format(result.execution_time) }}s</code>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="p-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                <h3 class="text-lg font-bold">⚠️ EXECUTION FAILED</h3>
                <p>The  module encountered a critical error during processing.</p>
                <div class="mt-3">
                    <strong class="text-primary">Error Details:</strong>
                    <div class="mt-2 p-2 bg-input rounded-md">
                        <code id="error-text">{{ result.error }}</code>
                    </div>
                    {{ button(variant='outline', text='COPY ERROR LOG', id='copyBtn', class='mt-2') }}
                </div>
            </div>
        {% endif %}
    </div>

    {% if result.success and result.data %}
    <div class="flex flex-wrap -mx-4">
        <!-- Results Display -->
        <div class="w-full lg:w-2/3 px-4">
            <div class="bg-card text-card-foreground rounded-lg shadow-md">
                <div class="p-4 border-b border-border">
                    <h3 class="text-xl font-bold">{{ plugin.name|upper }} OUTPUT</h3>
                    <p class="text-sm text-muted-foreground"> Processing Results</p>
                </div>
                <div class="p-4">
                    {% if result.data.custom_template is defined %}
                        {% include result.data.custom_template %}
                    {% else %}
                        <table class="w-full text-sm text-left text-foreground">
                            <thead class="text-xs text-muted-foreground uppercase bg-muted">
                                <tr>
                                    <th scope="col" class="px-6 py-3">DATA FIELD</th>
                                    <th scope="col" class="px-6 py-3">OUTPUT VALUE</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, value in result.data.items() %}
                                <tr class="bg-card border-b border-border">
                                    <th scope="row" class="px-6 py-4 font-medium text-foreground whitespace-nowrap">{{ key.replace('_', ' ')|upper }}</th>
                                    <td class="px-6 py-4">
                                        {% if value is mapping %}
                                            <button type="button" class="text-primary hover:underline" onclick="toggleData('{{ key }}')">VIEW OBJECT DATA</button>
                                            <div id="data-{{ key }}" class="hidden mt-2 p-2 bg-input rounded-lg"><pre><code>{{ value | tojsonpretty }}</code></pre></div>
                                        {% elif value is sequence and value is not string %}
                                            {% if value|length > 10 %}
                                                <button type="button" class="text-primary hover:underline" onclick="toggleData('{{ key }}')">VIEW {{ value|length }} ITEMS</button>
                                                <div id="data-{{ key }}" class="hidden mt-2 p-2 bg-input rounded-lg">
                                                    <ul class="list-disc list-inside">{% for item in value %}<li>{{ item }}</li>{% endfor %}</ul>
                                                </div>
                                            {% else %}
                                                <ul class="list-disc list-inside">{% for item in value %}<li>{{ item }}</li>{% endfor %}</ul>
                                            {% endif %}
                                        {% elif value is number %}
                                            <span class="text-primary">{{ value }}</span>
                                        {% elif value|string|length > 100 %}
                                            <button type="button" class="text-primary hover:underline" onclick="toggleData('{{ key }}')">VIEW LONG TEXT ({{ value|string|length }} chars)</button>
                                            <div id="data-{{ key }}" class="hidden mt-2 p-2 bg-input rounded-lg"><div>{{ value }}</div></div>
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar Information -->
        <div class="w-full lg:w-1/3 px-4">
            <!-- Input Summary -->
            <div class="mb-4 bg-card text-card-foreground rounded-lg shadow-md">
                <div class="p-4 border-b border-border">
                    <h5 class="text-xl font-bold">INPUT PARAMETERS</h5>
                </div>
                <div class="p-4 space-y-4">
                    {% if input_data.input_file %}
                        <div>
                            <dt class="font-bold">File Upload:</dt>
                            <dd><code>{{ input_data.input_file.filename }}</code></dd>
                        </div>
                    {% endif %}
                    {% for key, value in input_data.items() %}
                        {% if key != 'input_file' %}
                            <div>
                                <dt class="font-bold">{{ key.replace('_', ' ')|upper }}:</dt>
                                <dd>
                                    {% if value|string|length > 50 %}
                                        <button type="button" class="text-primary hover:underline" onclick="toggleData('input-{{ key }}')">VIEW INPUT</button>
                                        <div id="data-input-{{ key }}" class="hidden mt-2 p-2 bg-input rounded-lg"><div>{{ value }}</div></div>
                                    {% else %}
                                        <code>{{ value }}</code>
                                    {% endif %}
                                </dd>
                            </div>
                        {% endif %}
                    {% endfor %}
                    {% if not input_data or input_data|length == 0 %}
                        <p class="text-muted-foreground">No input parameters provided.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Execution Stats -->
            <div class="mb-4 bg-card text-card-foreground rounded-lg shadow-md">
                <div class="p-4 border-b border-border">
                    <h5 class="text-xl font-bold">EXECUTION STATS</h5>
                </div>
                <div class="p-4">
                    <dl class="grid grid-cols-2 gap-2">
                        <dt class="font-bold">Module ID:</dt> <dd><code>{{ plugin.id }}</code></dd>
                        <dt class="font-bold">Status:</dt>
                        <dd>
                            {% if result.success %}<span class="text-green-500">✓ SUCCESS</span>
                            {% else %}<span class="text-red-500">✗ FAILED</span>{% endif %}
                        </dd>
                        {% if result.execution_time %}<dt class="font-bold">Processing Time:</dt> <dd><code>{{ "%.3f"|format(result.execution_time) }}s</code></dd>{% endif %}
                        <dt class="font-bold">Output Fields:</dt> <dd>{{ result.data|length if result.data else 0 }} field(s)</dd>
                        <dt class="font-bold">Timestamp:</dt> <dd id="execution-timestamp"></dd>
                    </dl>
                </div>
            </div>
            
            <!-- Raw JSON Output -->
            <div class="bg-card text-card-foreground rounded-lg shadow-md">
                <div class="p-4 border-b border-border">
                    <h5 class="text-xl font-bold">RAW DATA EXPORT</h5>
                </div>
                <div class="p-4">
                    <button type="button" class="w-full text-left p-2 bg-muted hover:bg-muted/80 rounded-lg font-bold" onclick="toggleRawData()">VIEW JSON OUTPUT</button>
                    <div id="rawCollapse" class="hidden mt-2 p-2 bg-input rounded-lg">
                        <pre class="text-sm"><code>{{ result.data | tojsonpretty }}</code></pre>
                        {{ button(variant='outline', text='COPY JSON', id='copyJsonBtn', class='mt-2') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Copy error to clipboard
function copyToClipboard() {
    const errorText = document.getElementById('error-text').innerText;
    navigator.clipboard.writeText(errorText);
    const copyBtn = document.getElementById('copyBtn');
    copyBtn.innerHTML = `{{ button(variant='outline', text='✓ COPIED') }}`;
    setTimeout(() => {
        copyBtn.innerHTML = `{{ button(variant='outline', text='COPY ERROR LOG') }}`;
    }, 2000);
}

// Copy JSON to clipboard
function copyJsonToClipboard() {
    const jsonText = document.querySelector('#rawCollapse pre code').innerText;
    navigator.clipboard.writeText(jsonText);
    const copyJsonBtn = document.getElementById('copyJsonBtn');
    copyJsonBtn.innerHTML = `{{ button(variant='outline', text='✓ COPIED') }}`;
    setTimeout(() => {
        copyJsonBtn.innerHTML = `{{ button(variant='outline', text='COPY JSON') }}`;
    }, 2000);
}

// Toggle data displays
function toggleData(key) {
    const element = document.getElementById('data-' + key);
    element.classList.toggle('hidden');
    const button = event.target;
    if (element.classList.contains('hidden')) {
        button.textContent = button.textContent.replace('HIDE', 'VIEW');
    } else {
        button.textContent = button.textContent.replace('VIEW', 'HIDE');
    }
}

// Toggle raw data display
function toggleRawData() {
    const element = document.getElementById('rawCollapse');
    element.classList.toggle('hidden');
    const button = event.target;
    if (element.classList.contains('hidden')) {
        button.textContent = 'VIEW JSON OUTPUT';
    } else {
        button.textContent = 'HIDE JSON OUTPUT';
    }
}

// Set execution timestamp
function setTimestamp() {
    const now = new Date();
    const timestamp = now.getFullYear() + '.' + 
                     String(now.getMonth() + 1).padStart(2, '0') + '.' + 
                     String(now.getDate()).padStart(2, '0') + '.' + 
                     String(now.getHours()).padStart(2, '0') + ':' + 
                     String(now.getMinutes()).padStart(2, '0') + ':' + 
                     String(now.getSeconds()).padStart(2, '0');
    const timestampElement = document.getElementById('execution-timestamp');
    if (timestampElement) {
        timestampElement.textContent = timestamp;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setTimestamp();
});
</script>
{% endblock %} 