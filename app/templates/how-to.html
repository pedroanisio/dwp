{% extends "base.html" %}

{% block title %}How to Build Plugins{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-light border-dark">
        <div class="card-header">
            <h1 class="card-title">How to Build a New Plugin</h1>
        </div>
        <div class="card-body">
            <p class="lead">This guide provides a complete walkthrough of how to create, test, and troubleshoot your own custom plugins.</p>

            <hr class="my-4">

            <h2 class="mb-3">1. The Anatomy of a Plugin</h2>
            <p>Every plugin is self-contained within its own directory inside <code>app/plugins/</code>. At a minimum, a plugin must include two files:</p>
            <ul>
                <li><code>manifest.json</code>: A JSON file that defines the plugin's metadata, UI, and dependencies.</li>
                <li><code>plugin.py</code>: A Python script that contains the core logic of the plugin.</li>
            </ul>
            <p>For Python-based plugins that have their own internal modules, you should also include an empty <code>__init__.py</code> file in the same directory.</p>

            <div class="accordion" id="development-steps">
                
                <!-- Step 1: Manifest -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            <strong>Step 1: Define the Manifest (`manifest.json`)</strong>
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#development-steps">
                        <div class="accordion-body">
                            <p>The <code>manifest.json</code> file is the heart of your plugin. It tells the system everything it needs to know to render the UI, validate inputs, and execute your code. Below is an example from the Pandoc Converter plugin:</p>
                            <pre class="bg-dark text-white p-2 rounded"><code>{
  "id": "pandoc_converter",
  "name": "Pandoc Document Converter",
  "version": "1.0.0",
  "description": "Converts documents from one format to another using Pandoc.",
  "author": "AI Assistant",
  "inputs": [
    {
      "name": "input_file",
      "label": "Source Document",
      "field_type": "file",
      "required": true,
      "help": "Upload the document you want to convert."
    },
    {
      "name": "output_format",
      "label": "Output Format",
      "field_type": "select",
      "required": true,
      "options": [
        {"value": "docx", "label": "Word Document"},
        {"value": "pdf", "label": "PDF"},
        {"value": "html", "label": "HTML"},
        {"value": "md", "label": "Markdown"}
      ],
      "default_value": "docx"
    }
  ],
  "output": {
    "name": "converted_file",
    "description": "The converted output file."
  },
  "dependencies": {
    "external": [{"name": "pandoc"}]
  }
}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Plugin Logic -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            <strong>Step 2: Implement the Logic (`plugin.py`)</strong>
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#development-steps">
                        <div class="accordion-body">
                            <p>The <code>plugin.py</code> file must contain a <code>Plugin</code> class with an <code>execute</code> method. This method takes a dictionary of the user's input and should return a dictionary containing the output.</p>
                            <p>For plugins that generate a file, the `execute` method should return a dictionary with `file_path` and `file_name` keys.</p>
                            <pre class="bg-dark text-white p-2 rounded"><code>from pathlib import Path
import subprocess
import tempfile
from typing import Dict, Any

class Plugin:
    def execute(self, data: Dict[str, Any]) -> Dict[str, Any]:
        input_file = data.get("input_file")
        output_format = data.get("output_format")

        if not input_file or not output_format:
            raise ValueError("Missing required inputs.")

        # Create a temporary directory to store files
        with tempfile.TemporaryDirectory() as temp_dir:
            input_path = Path(temp_dir) / input_file["filename"]
            with open(input_path, "wb") as f:
                f.write(input_file["content"])

            # Prepare the output path
            output_filename = f"{input_path.stem}.{output_format}"
            output_path = Path(temp_dir) / output_filename
            
            # Execute the pandoc command
            subprocess.run(
                ["pandoc", str(input_path), "-o", str(output_path)],
                check=True
            )

            # Return the path to the generated file
            return {
                "file_path": str(output_path),
                "file_name": output_filename
            }
</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <h2 class="mb-3">2. Testing Your Plugin</h2>
            <p>To test your plugin, simply restart the web application. It will be automatically discovered and loaded. You can then test it using either the web interface or the API.</p>

            <h4 class="mt-3">Via the Web Interface</h4>
            <ol>
                <li>Navigate to the <a href="/">homepage</a>.</li>
                <li>Find your plugin and click "Use Plugin".</li>
                <li>Fill out the form and click "Execute Plugin" to see the results.</li>
            </ol>

            <h4 class="mt-3">Via the API with `curl`</h4>
            <p>You can also test your plugin programmatically. First, get the list of plugins to find your plugin's ID:</p>
            <pre class="bg-dark text-white p-2 rounded"><code>curl http://localhost:8000/api/plugins</code></pre>
            <p>Then, send a POST request to your plugin's `execute` endpoint. For file uploads, use the `-F` flag:</p>
            <pre class="bg-dark text-white p-2 rounded"><code>curl -X POST -F "input_file=@/path/to/your/document.md" \
-F "output_format=docx" http://localhost:8000/api/plugin/pandoc_converter/execute \
--output converted_document.docx</code></pre>

            <hr class="my-4">

            <h2 class="mb-3">3. Troubleshooting Tips</h2>
            <div class="alert alert-warning">
                <ul class="mb-0">
                    <li><strong>Plugin Not Loading</strong>: Double-check your <code>manifest.json</code> for syntax errors. Make sure your <code>plugin.py</code> has a <code>Plugin</code> class with a valid <code>execute</code> method.</li>
                    <li><strong>Dependency Errors</strong>: If your plugin relies on external tools (like `pandoc`), make sure they are installed on the server and accessible in the system's `PATH`.
                    <li><strong>Validation Errors</strong>: Ensure the data you provide matches the input types defined in your manifest. All required fields must be provided.</li>
                </ul>
            </div>

        </div>
    </div>
</div>
{% endblock %} 